<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sistem Akademik UNIKI</title>

    <!-- CSS ASLI -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400&family=Sono:wght@200;300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-icons.css">
    <link rel="stylesheet" href="css/templatemo-pod-talk.css">

    <style>
        .page{display:none}
        .page.active{display:block}
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .login-form {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
    </style>
</head>

<body>

<!-- Login Form (Awal) -->
<div id="loginPage" class="login-form">
    <h2 class="text-center mb-4">Login Admin UNIKI</h2>
    <div id="loginError" class="alert alert-danger" style="display:none"></div>
    <div class="mb-3">
        <label>Email</label>
        <input type="email" id="loginEmail" class="form-control" placeholder="admin@uniki.ac.id">
    </div>
    <div class="mb-3">
        <label>Password</label>
        <input type="password" id="loginPassword" class="form-control" placeholder="********">
    </div>
    <button class="btn btn-primary w-100" onclick="login()">Login</button>
    <div id="loginLoading" class="loader" style="display:none"></div>
</div>

<!-- Main App (Sembunyi sampai login) -->
<div id="mainApp" style="display:none">

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg">
    <div class="container">
        <a class="navbar-brand me-lg-5 me-0" href="#">
            <img src="images/pod-talk-logo.png" class="logo-image img-fluid" alt="UNIKI">
        </a>

        <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#nav">
            <span class="navbar-toggler-icon"></span>
        </button>
        
        <div class="collapse navbar-collapse" id="nav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link active" onclick="showPage('mahasiswa')">Mahasiswa</a></li>
                <li class="nav-item"><a class="nav-link" onclick="showPage('dosen')">Dosen</a></li>
                <li class="nav-item"><a class="nav-link" onclick="showPage('dekan')">Dekan</a></li>
                <li class="nav-item"><a class="nav-link" onclick="showPage('matkul')">Mata Kuliah</a></li>
                <li class="nav-item">
                    <button class="btn btn-danger btn-sm ms-2" onclick="logout()">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </button>
                </li>
            </ul>
        </div>
    </div>
</nav>

<header class="site-header d-flex flex-column justify-content-center align-items-center">
    <div class="container">
        <div class="row">
            <div class="col-lg-12 col-12 text-center">
                <h2 class="mb-0">UNIVERSITAS ISLAM KEBANGSAAN INDONESIA</h2>
                <p>Sistem Manajemen Akademik</p>
            </div>
        </div>
    </div>
</header>

<!-- ================= MAHASISWA ================= -->
<div id="mahasiswa" class="page active container section-padding">
    <h4>Data Mahasiswa</h4>
    <button class="btn btn-primary mb-3" onclick="openForm('mahasiswa', 'Tambah Mahasiswa')">+ Tambah Mahasiswa</button>
    <div id="mahasiswaLoading" class="loader" style="display:none"></div>
    
    <div class="table-responsive">
        <table class="table table-striped">
            <thead><tr><th>No</th><th>NIM</th><th>Nama</th><th>Jurusan</th><th>Angkatan</th><th>Email</th><th>Aksi</th></tr></thead>
            <tbody id="tblMahasiswa"></tbody>
        </table>
    </div>
</div>

<!-- ================= DOSEN ================= -->
<div id="dosen" class="page container section-padding">
    <h4>Data Dosen</h4>
    <button class="btn btn-primary mb-3" onclick="openForm('dosen', 'Tambah Dosen')">+ Tambah Dosen</button>
    <div id="dosenLoading" class="loader" style="display:none"></div>
    
    <div class="table-responsive">
        <table class="table table-striped">
            <thead><tr><th>No</th><th>NIDN</th><th>Nama</th><th>Prodi</th><th>Email</th><th>Telp</th><th>Aksi</th></tr></thead>
            <tbody id="tblDosen"></tbody>
        </table>
    </div>
</div>

<!-- ================= DEKAN ================= -->
<div id="dekan" class="page container section-padding">
    <h4>Data Dekan</h4>
    <button class="btn btn-primary mb-3" onclick="openForm('dekan', 'Tambah Dekan')">+ Tambah Dekan</button>
    <div id="dekanLoading" class="loader" style="display:none"></div>
    
    <div class="table-responsive">
        <table class="table table-striped">
            <thead><tr><th>No</th><th>Nama</th><th>Fakultas</th><th>Email</th><th>Telp</th><th>Masa Jabatan</th><th>Aksi</th></tr></thead>
            <tbody id="tblDekan"></tbody>
        </table>
    </div>
</div>

<!-- ================= MATA KULIAH ================= -->
<div id="matkul" class="page container section-padding">
    <h4>Data Mata Kuliah</h4>
    <button class="btn btn-primary mb-3" onclick="openForm('matkul', 'Tambah Mata Kuliah')">+ Tambah Mata Kuliah</button>
    <div id="matkulLoading" class="loader" style="display:none"></div>
    
    <div class="table-responsive">
        <table class="table table-striped">
            <thead><tr><th>No</th><th>Kode</th><th>Nama</th><th>SKS</th><th>Semester</th><th>Dosen Pengampu</th><th>Aksi</th></tr></thead>
            <tbody id="tblMatkul"></tbody>
        </table>
    </div>
</div>

<!-- ================= MODAL GLOBAL ================= -->
<div class="modal fade" id="modalForm">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="modalTitle"></h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button class="btn btn-primary" onclick="saveData()" id="saveBtn">Simpan</button>
            </div>
        </div>
    </div>
</div>

</div> <!-- end mainApp -->

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<script src="js/bootstrap.bundle.min.js"></script>
<script>
// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyBSVWxCcvR3gtamwQNcSTHN1Z7fMSjwaiI",
    authDomain: "final-c1d8d.firebaseapp.com",
    projectId: "final-c1d8d",
    storageBucket: "final-c1d8d.firebasestorage.app",
    messagingSenderId: "596660533464",
    appId: "1:596660533464:web:f89e2fa38ce00ae2cd3fad",
    measurementId: "G-7FY499VRPY"
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let modal = null;
let currentType = "";
let editId = "";
let currentUser = null;

// Check auth state
auth.onAuthStateChanged((user) => {
    if (user) {
        currentUser = user;
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        loadAllData();
    } else {
        document.getElementById('loginPage').style.display = 'block';
        document.getElementById('mainApp').style.display = 'none';
    }
});

// Login Function
async function login() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const errorDiv = document.getElementById('loginError');
    const loading = document.getElementById('loginLoading');
    
    errorDiv.style.display = 'none';
    loading.style.display = 'block';
    
    try {
        await auth.signInWithEmailAndPassword(email, password);
    } catch (error) {
        errorDiv.style.display = 'block';
        errorDiv.textContent = error.message;
        loading.style.display = 'none';
    }
}

// Logout Function
function logout() {
    auth.signOut();
}

// Initialize Modal
document.addEventListener('DOMContentLoaded', function() {
    modal = new bootstrap.Modal(document.getElementById("modalForm"));
});

// Show Page Function
function showPage(id) {
    document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
    document.getElementById(id).classList.add("active");
}

// Open Form Function
function openForm(type, title, editData = null) {
    currentType = type;
    editId = editData ? editData.id : "";
    
    document.getElementById("modalTitle").innerText = title;
    
    // Define form fields based on type
    const fields = {
        mahasiswa: [
            { id: 'nim', label: 'NIM', type: 'text', value: editData?.nim || '' },
            { id: 'nama', label: 'Nama Lengkap', type: 'text', value: editData?.nama || '' },
            { id: 'jurusan', label: 'Jurusan', type: 'text', value: editData?.jurusan || '' },
            { id: 'angkatan', label: 'Angkatan', type: 'text', value: editData?.angkatan || '' },
            { id: 'email', label: 'Email', type: 'email', value: editData?.email || '' },
            { id: 'telp', label: 'Telepon', type: 'text', value: editData?.telp || '' }
        ],
        dosen: [
            { id: 'nidn', label: 'NIDN', type: 'text', value: editData?.nidn || '' },
            { id: 'nama', label: 'Nama Lengkap', type: 'text', value: editData?.nama || '' },
            { id: 'prodi', label: 'Program Studi', type: 'text', value: editData?.prodi || '' },
            { id: 'email', label: 'Email', type: 'email', value: editData?.email || '' },
            { id: 'telp', label: 'Telepon', type: 'text', value: editData?.telp || '' },
            { id: 'jabatan', label: 'Jabatan', type: 'text', value: editData?.jabatan || '' }
        ],
        dekan: [
            { id: 'nama', label: 'Nama Lengkap', type: 'text', value: editData?.nama || '' },
            { id: 'fakultas', label: 'Fakultas', type: 'text', value: editData?.fakultas || '' },
            { id: 'email', label: 'Email', type: 'email', value: editData?.email || '' },
            { id: 'telp', label: 'Telepon', type: 'text', value: editData?.telp || '' },
            { id: 'masa_jabatan', label: 'Masa Jabatan', type: 'text', value: editData?.masa_jabatan || '' },
            { id: 'gelar', label: 'Gelar Akademik', type: 'text', value: editData?.gelar || '' }
        ],
        matkul: [
            { id: 'kode', label: 'Kode Matkul', type: 'text', value: editData?.kode || '' },
            { id: 'nama', label: 'Nama Mata Kuliah', type: 'text', value: editData?.nama || '' },
            { id: 'sks', label: 'SKS', type: 'number', value: editData?.sks || '' },
            { id: 'semester', label: 'Semester', type: 'number', value: editData?.semester || '' },
            { id: 'dosen', label: 'Dosen Pengampu', type: 'text', value: editData?.dosen || '' },
            { id: 'prodi', label: 'Program Studi', type: 'text', value: editData?.prodi || '' }
        ]
    };
    
    const formHTML = fields[type].map(field => `
        <div class="mb-3">
            <label class="form-label">${field.label}</label>
            <input type="${field.type}" id="${field.id}" class="form-control" 
                   value="${field.value}" ${field.type === 'number' ? 'min="1" max="8"' : ''}>
        </div>
    `).join('');
    
    document.getElementById("modalBody").innerHTML = formHTML;
    modal.show();
}

// Save Data to Firestore
async function saveData() {
    const saveBtn = document.getElementById('saveBtn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'Menyimpan...';
    
    const inputs = document.querySelectorAll("#modalBody input");
    const data = {};
    inputs.forEach(input => {
        data[input.id] = input.value;
    });
    
    try {
        if (editId) {
            // Update existing document
            await db.collection(currentType).doc(editId).update(data);
        } else {
            // Add new document
            data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            await db.collection(currentType).add(data);
        }
        
        modal.hide();
        loadData(currentType);
    } catch (error) {
        alert("Error menyimpan data: " + error.message);
    } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Simpan';
    }
}

// Delete Data
async function deleteData(type, id) {
    if (!confirm("Apakah Anda yakin ingin menghapus data ini?")) return;
    
    try {
        await db.collection(type).doc(id).delete();
        loadData(type);
    } catch (error) {
        alert("Error menghapus data: " + error.message);
    }
}

// Load All Data
async function loadAllData() {
    await Promise.all([
        loadData('mahasiswa'),
        loadData('dosen'),
        loadData('dekan'),
        loadData('matkul')
    ]);
}

// Load Specific Data
async function loadData(type) {
    const loadingElement = document.getElementById(`${type}Loading`);
    const tableBody = document.getElementById(`tbl${type.charAt(0).toUpperCase() + type.slice(1)}`);
    
    if (loadingElement) loadingElement.style.display = 'block';
    
    try {
        const snapshot = await db.collection(type).orderBy('createdAt', 'desc').get();
        
        if (snapshot.empty) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Tidak ada data</td></tr>';
            return;
        }
        
        const rows = [];
        let index = 1;
        
        snapshot.forEach(doc => {
            const data = doc.data();
            rows.push(generateRowHTML(type, index++, doc.id, data));
        });
        
        tableBody.innerHTML = rows.join('');
    } catch (error) {
        console.error("Error loading data:", error);
        tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Error: ${error.message}</td></tr>`;
    } finally {
        if (loadingElement) loadingElement.style.display = 'none';
    }
}

// Generate Row HTML
function generateRowHTML(type, index, id, data) {
    const baseActions = `
        <button class="btn btn-warning btn-sm me-2" onclick="openForm('${type}', 'Edit Data', {id: '${id}', ...${JSON.stringify(data).replace(/"/g, '&quot;')})">Edit</button>
        <button class="btn btn-danger btn-sm" onclick="deleteData('${type}', '${id}')">Hapus</button>
    `;
    
    switch(type) {
        case 'mahasiswa':
            return `
                <tr>
                    <td>${index}</td>
                    <td>${data.nim || ''}</td>
                    <td>${data.nama || ''}</td>
                    <td>${data.jurusan || ''}</td>
                    <td>${data.angkatan || ''}</td>
                    <td>${data.email || ''}</td>
                    <td>${baseActions}</td>
                </tr>
            `;
        case 'dosen':
            return `
                <tr>
                    <td>${index}</td>
                    <td>${data.nidn || ''}</td>
                    <td>${data.nama || ''}</td>
                    <td>${data.prodi || ''}</td>
                    <td>${data.email || ''}</td>
                    <td>${data.telp || ''}</td>
                    <td>${baseActions}</td>
                </tr>
            `;
        case 'dekan':
            return `
                <tr>
                    <td>${index}</td>
                    <td>${data.nama || ''}</td>
                    <td>${data.fakultas || ''}</td>
                    <td>${data.email || ''}</td>
                    <td>${data.telp || ''}</td>
                    <td>${data.masa_jabatan || ''}</td>
                    <td>${baseActions}</td>
                </tr>
            `;
        case 'matkul':
            return `
                <tr>
                    <td>${index}</td>
                    <td>${data.kode || ''}</td>
                    <td>${data.nama || ''}</td>
                    <td>${data.sks || ''}</td>
                    <td>${data.semester || ''}</td>
                    <td>${data.dosen || ''}</td>
                    <td>${baseActions}</td>
                </tr>
            `;
        default:
            return '';
    }
}

// Auto-create collections if they don't exist (optional)
async function initializeCollections() {
    const collections = ['mahasiswa', 'dosen', 'dekan', 'matkul'];
    for (const collection of collections) {
        const snapshot = await db.collection(collection).limit(1).get();
        if (snapshot.empty) {
            // Add a dummy document to create collection
            await db.collection(collection).add({
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                placeholder: true
            }).then(doc => {
                // Remove the dummy document
                db.collection(collection).doc(doc.id).delete();
            });
        }
    }
}

// Initialize on page load
window.onload = function() {
    initializeCollections();
};
</script>

</body>
</html>